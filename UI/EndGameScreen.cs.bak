using Myra.Graphics2D.UI;
using Microsoft.Xna.Framework;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using rurik;

namespace rurik.UI
{
    public class EndGameScreen : IGameScreen
    {
        private Panel _panel;
        private Grid _grid;
        private Label _titleLabel;
        private ScrollViewer _scrollViewer;
        private StackPanel _contentPanel;
        private Button _closeButton;
        private bool _isVisible = false;

        public EndGameScreen()
        {
            Initialize();
        }

        public void Initialize()
        {
            _panel = new Panel()
            {
                Id = "endGameDiv",
                Background = Color.Gray,
                Width = 600,
                Height = 400,
                HorizontalAlignment = HorizontalAlignment.Center,
                VerticalAlignment = VerticalAlignment.Center,
            };

            _grid = new Grid()
            {
                Id = "endGameContent",
                Background = Color.Gray,
                Padding = new Thickness(10),
                HorizontalAlignment = HorizontalAlignment.Stretch,
                VerticalAlignment = VerticalAlignment.Stretch,
            };

            _grid.RowsProportions.Add(new Proportion(ProportionType.Auto));
            _grid.RowsProportions.Add(new Proportion(ProportionType.Auto));
            _grid.RowsProportions.Add(new Proportion(ProportionType.Auto));

            _grid.ColumnsProportions.Add(new Proportion(ProportionType.Auto));

            _titleLabel = new Label()
            {
                Id = "endGameTitle",
                Text = "End Game Summary",
                HorizontalAlignment = HorizontalAlignment.Center,
                VerticalAlignment = VerticalAlignment.Center,
                Background = Color.Gray,
                Border = new Border()
                {
                    Thickness = new Thickness(1),
                    Color = Color.Black
                }
            };

            _scrollViewer = new ScrollViewer()
            {
                Id = "endGameTableDiv",
                Width = 580,
                Height = 300,
                HorizontalAlignment = HorizontalAlignment.Stretch,
                VerticalAlignment = VerticalAlignment.Stretch,
            };

            _contentPanel = new StackPanel()
            {
                Id = "endGameContentPanel",
                Orientation = Orientation.Vertical,
                HorizontalAlignment = HorizontalAlignment.Stretch,
                VerticalAlignment = VerticalAlignment.Stretch,
            };

            _scrollViewer.Widgets.Add(_contentPanel);

            _closeButton = new Button()
            {
                Id = "closeEndGameModal",
                Text = "Ã—",
                Width = 30,
                Height = 30,
                HorizontalAlignment = HorizontalAlignment.Right,
                VerticalAlignment = VerticalAlignment.Top,
            };

            _closeButton.Click += (s, a) => Hide();

            _grid.Widgets.Add(_titleLabel);
            _grid.Widgets.Add(_scrollViewer);
            _grid.Widgets.Add(_closeButton);

            _panel.Widgets.Add(_grid);
        }

        public void Update()
        {
            // Update logic if needed
        }

        public void Draw()
        {
            // Draw logic if needed
        }

        public void Show()
        {
            _isVisible = true;
            // Add to desktop or parent container
        }

        public void Hide()
        {
            _isVisible = false;
            // Remove from desktop or parent container
        }

        public void HandleEvent(string eventName, object data)
        {
            switch (eventName)
            {
                case "showEndGame":
                    if (data is Dictionary<string, object> endGameStats)
                    {
                        UpdateEndGameContent(endGameStats);
                    }
                    break;
            }
        }

        private void UpdateEndGameContent(Dictionary<string, object> endGameStats)
        {
            _contentPanel.Widgets.Clear();
            
            foreach (var kvp in endGameStats)
            {
                var statLabel = new Label()
                {
                    Text = $"{kvp.Key}: {kvp.Value}",
                    HorizontalAlignment = HorizontalAlignment.Left,
                    VerticalAlignment = VerticalAlignment.Center,
                };
                
                _contentPanel.Widgets.Add(statLabel);
            }
        }

        public void SetEndGameStats(Dictionary<string, object> stats)
        {
            UpdateEndGameContent(stats);
        }
    }
}
